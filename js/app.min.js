function init(){if(""!==my_token&&$.get("https://"+server_uri+"/profile?token="+my_token,function(e){e.ok||"#pages__sms"===lasturl?(my_phone=e.profile.phone,my_name=e.profile.name,my_city=e.profile.city,my_avatar=e.profile.photo,$(".jq_my_name").length&&($(".jq_my_name").html(my_name),$(".jq_my_phone").html(my_phone),my_avatar||(my_avatar=default_avatar),$(".menu__desc_avatar").prop("src",my_avatar))):(is_auth=!1,my_token="",localStorage.removeItem("_is_auth"),localStorage.removeItem("_my_token"))},"json"),document.querySelectorAll('[data-id="driver_city_orders"]').length&&$.get("https://"+server_uri+"/orders?token="+my_token+"&isIntercity=0&fromCity="+my_city,function(e){function t(e,t){var n=document.createElement(e);n.innerHTML=t,o.appendChild(n)}console.log("Ok?: "+e.ok+", orders="+e.orders),console.log("Messages: "+e.messages);for(var o=document.querySelectorAll(".list-orders")[0],n=0;n<e.orders.length;n++)t("LI",'<div class="list-orders_personal"><img src="'+e.orders[n].agent.photo+'" alt="" /><br/>'+e.orders[n].agent.name+"<br/>"+datetimeForPeople(e.orders[n].created)+'</div><div class="list-orders_route"><div class="list-orders_route_from">'+e.orders[n].fromAddress+'</div><div class="list-orders_route_to">'+e.orders[n].toAddress0+'</div><div class="list-orders_route_info"><span>'+e.orders[n].price+' руб.</span> <i class="icon-direction-outline"></i>? км</div><div class="list-orders_route_additional">'+e.orders[n].comment+"</div></div>");e.orders.length<1&&t("DIV",'<div class="list-orders_norecords">Нет заказов</div>')},"json"),document.querySelectorAll('[data-id="client_my_orders"]').length&&$.get("https://"+server_uri+"/orders?token="+my_token+"&isIntercity=0&my=1",function(e){function t(e,t){var n=document.createElement(e);n.innerHTML=t,o.appendChild(n)}console.log("Ok?: "+e.ok+", orders="+e.orders),console.log("Messages: "+e.messages);for(var o=document.querySelectorAll(".myorders")[0],n=0;n<e.orders.length;n++)t("LI",'<p class="myorders__time">'+datetimeForPeople(e.orders[n].created)+'</p><p class="myorders__from">'+e.orders[n].fromAddress+'</p><p class="myorders__to">'+e.orders[n].toAddress0+'</p><p class="myorders__summa">'+e.orders[n].price+'</p><p class="myorders__info">'+e.orders[n].comment+"</p>");e.orders.length<1&&t("DIV",'<div class="list-orders_norecords">Нет заказов</div>')},"json"),$(".jq_form-edit-auto").length&&($.get("https://"+server_uri+"/profile?token="+my_token,function(e){$('input[name="color"]').val(e.profile.color),$('input[name="number"]').val(e.profile.number),$('input[name="model"]').val(e.profile.model),$('input[name="tonnage"]').val(e.profile.tonnage);var t=$('select[name="brand"] option[value="'+e.profile.brand+'"]');t.attr("selected","true")},"json"),$.get("https://"+server_uri+"/auto?token="+my_token,function(e){var t=$(e.auto.conditioner?'input[name="conditioner"][value="1"]':'input[name="conditioner"][value="0"]');t.attr("checked","checked");var o=$('select[name="type"] option[value="'+e.auto.type+'"]');o.attr("selected","true")},"json")),$(".jq_form-edit-profile").length&&$.get("https://"+server_uri+"/profile?token="+my_token,function(e){$('input[name="name"]').val(e.profile.name),$('input[name="dob"]').val(dateFromBase(e.profile.birthday));var t=$(e.profile.sex?'select[name="sex"] option[value="1"]':'select[name="sex"] option[value="0"]');t.attr("selected","true");var o=$('select[name="city"] option[value="'+e.profile.city+'"]');o.attr("selected","true"),$(".avatar").prop("src",my_avatar)},"json"),$(".content").css("height",$(window).outerHeight()-$(".header").outerHeight()),tabs=$(".tabs ul li"),tabs.length){var e=tabs.length;tabs.css("width",100/e-1+"%"),$(".tabs__viewport").css("width",e*$(window).width()+"px"),$(".tabs_content").css("width",$(window).width()),new Hammer($(".tabs__wrapper")[0],{domEvents:!0})}$(".form-order-city").length&&($('input[name="from"]').val(localStorage.getItem("_address_from")),$('input[name="to"]').val(localStorage.getItem("_address_to"))),$("#map_canvas_choice").length&&initialize_choice(),$("#map_canvas").length&&initialize(),$(".tabs_content").on("swipeleft",function(){swipeTabs(1)}),$(".tabs_content").on("swiperight",function(){swipeTabs(-1)})}function geoFindMe(){function e(e){var t=e.coords.latitude,o=e.coords.longitude;my_position.x=t,my_position.y=o,geocoder=new google.maps.Geocoder;var n=new google.maps.LatLng(t,o);geocoder.geocode({latLng:n},function(e,t){if(t===google.maps.GeocoderStatus.OK){var o,n=e[0].address_components;for(o in n)"locality"===n[o].types[0]&&""!==my_city&&(my_city=n[o].long_name),"country"===n[o].types[0]&&(my_coutry=n[o].long_name)}})}function t(){alert("На вашем устройстве не разрешен доступ к местоположению.")}return navigator.geolocation?void navigator.geolocation.getCurrentPosition(e,t):void alert("К сожалению, геолокация не поддерживается в вашем браузере")}function swipeMenu(e){$(".menu").animate({left:e+"=80%"},250)}function swipeTabs(e){var t=$(".tab--active").data("tab");t+e<tabs.length+1&&t+e>0&&changeTab(t+e)}function changeTab(e){step=$(window).width(),$(".tabs_content").css("left",step-step*e+"px"),tabs.removeClass("tab--active"),$('*[data-tab="'+e+'"]').addClass("tab--active")}function checkURL(e){sublasturl=lasturl,e||(e=window.location.hash?window.location.hash:"#client__city"),e!==lasturl&&(lasturl=e,loadPage(e))}function loadPage(e){e=e.replace("#","");var t=e.split("__");document.querySelectorAll(".loading")[0].style.visibility="visible",$.ajax({dataType:"json",url:"routes.php",type:"POST",data:{section:t[0],page:t[1]},success:function(e){0!==parseInt(e)&&(document.querySelectorAll(".header__title")[0].innerHTML=e.title,document.querySelectorAll(".content")[0].innerHTML=e.content,(t[0]!==lastsection||""===lastsection)&&(document.querySelectorAll(".menu__response")[0].innerHTML=e[0].menu),lastsection=t[0],document.querySelectorAll(".loading")[0].style.visibility="hidden",init())}})}function initialize(){var e=new google.maps.LatLng(48.49,135.07),t=document.getElementById("map_canvas"),o={center:e,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(t,o),directionsService=new google.maps.DirectionsService;var n=loadAddress();requestDirections(n[0],n[1],{strokeColor:"#ff0000"})}function initialize_choice(){if(o=18,void 0===my_position.x||void 0===my_position.y)var e=48.4,t=135.07,o=12;else var e=my_position.x,t=my_position.y;var n=new google.maps.LatLng(e,t),a=document.getElementById("map_canvas_choice"),r={center:n,zoom:o,mapTypeId:google.maps.MapTypeId.ROADMAP};map_choice=new google.maps.Map(a,r),map_choice.getDiv().insertAdjacentHTML("beforeend",'<div class="centerMarker"></div>');var i=document.querySelectorAll(".centerMarker")[0];google.maps.event.addListener(map_choice,"drag",function(){var e=point2LatLng(i.offsetLeft,i.offsetTop,map_choice);localStorage.setItem("_choice_coords",e)})}function renderDirections(e,t){var o=new google.maps.DirectionsRenderer;o.setMap(map),t&&o.setOptions({polylineOptions:t}),o.setDirections(e)}function requestDirections(e,t,o){directionsService.route({origin:e,destination:t,travelMode:google.maps.DirectionsTravelMode.DRIVING},function(e){renderDirections(e,o)})}function getChar(e){return null===e.which?e.keyCode<32?null:String.fromCharCode(e.keyCode):0!==e.which?e.which<32?null:String.fromCharCode(e.which):null}function setTempRequestLS(e){return localStorage.setItem("_temp_request",e),!0}function getTempRequestLS(){var e=localStorage.getItem("_temp_request");return localStorage.removeItem("_temp_request"),e}function saveAddress(e,t){return localStorage.setItem("_address_from",e),localStorage.setItem("_address_to",t),!0}function loadAddress(){var e=my_city+","+localStorage.getItem("_address_from"),t=my_city+","+localStorage.getItem("_address_to");return[e,t]}function point2LatLng(e,t,o){var n=o.getProjection().fromLatLngToPoint(o.getBounds().getNorthEast()),a=o.getProjection().fromLatLngToPoint(o.getBounds().getSouthWest()),r=Math.pow(2,o.getZoom()),i=new google.maps.Point(e/r+a.x,t/r+n.y);return o.getProjection().fromPointToLatLng(i)}function getStreenFromGoogle(e){var t,o,n=e[0].address_components;for(t in n)"street_number"===n[t].types[0]&&(o=n[t].long_name),"route"===n[t].types[0]&&(o=n[t].long_name+","+o);return o}function searchCityForIntercity(e,t){for(var o,n=t.children[1].children,a=0;a<n.length;a++)o=n[a].children[1].children[3].innerHTML,n[a].style.display=o===e||""===e?"flex":"none"}function dateFromBase(e){return"0000-00-00"===e?e="":(e=e.split("-"),e=e[2]+"."+e[1]+"."+e[0]),e}function dateToBase(e){return e=e.split("."),e=e[2]+"-"+e[1]+"-"+e[0]}function datetimeForPeople(e,t){void 0===t&&(t="TIME_AND_TODAY"),e=e.split(" ");var o=new Date,n=new Date(o.getFullYear(),o.getMonth(),o.getDate()).valueOf(),a=e[0].valueOf();if(n-864e5>a){var r=e[0].split("-");today_text=r[2]+"."+r[1]+"."+r[0]}else today_text=n>a?"Вчера":"Сегодня";var r=e[1].split(":");return time_text=r[0]+":"+r[1],"ONLY_TIME"===t&&(e=time_text),"ONLY_TIME_IF_TODAY"===t&&(e="Сегодня"===today_text?time_text:today_text+", "+time_text),"TIME_AND_TODAY"===t&&(e=today_text+", "+time_text),e}var tabs,lasturl="",sublasturl="",lastsection="",map,map_choice,marker,geocoder,google,placeSearch,autocomplete,directionsService,my_position=["x","y"],server_uri="192.168.20.90",my_city,my_country,my_token,is_auth=!1,my_name,my_phone,my_avatar,default_avatar="images/no_avatar.png";document.addEventListener("DOMContentLoaded",function(){"true"===localStorage.getItem("_is_auth")&&(is_auth=!0),my_token=localStorage.getItem("_my_token"),geoFindMe();var e=document.querySelectorAll(".menu")[0];new Hammer(e,{domEvents:!0}),e.addEventListener("swipeleft",function(){swipeMenu("-")}),e.addEventListener("click",function(e){for(var t=e.target;t!==this;){if("A"===t.tagName){for(var o=t.parentNode,n=o.parentNode.querySelectorAll("li"),a=0;a<n.length;a++)n[a].className=n[a].className.replace(/^menu__list--active$/,"");o.className+="menu__list--active",swipeMenu("-")}if("edit_profile"===t.dataset.click)return swipeMenu("-"),void(document.location="#pages__edit_profile");t=t.parentNode}}),document.querySelectorAll(".header__burger")[0].addEventListener("click",function(){swipeMenu("+")});var t=document.querySelectorAll(".content")[0];t.addEventListener("click",function(e){for(var t=e.target;t!==this;){if(t.dataset.tab>0)return void changeTab(t.dataset.tab);if("choice_location"===t.dataset.click)return document.location="#client__choice_location_map",void setTempRequestLS(t.parentNode.querySelectorAll("input")[0].getAttribute("name"));if("field_add"===t.dataset.click){var o=document.querySelectorAll(".icon-record").length;if(3>o){var n=document.querySelectorAll(".order-city-to")[0],a=document.createElement("div");a.className+="form-order-city__field order-city-from",a.innerHTML='<i class="icon-record form-order-city__label"></i><span class="form-order-city__wrap"><input type="text" name="from_plus[]" value="" placeholder="Заезд"/></span><span data-click="field_delete" class="form-order-city__field_delete"><i class="icon-trash"></i></span>';var r=n.parentNode;r.insertBefore(a,n)}return}if("field_delete"===t.dataset.click){var i=t.parentNode;return void i.parentNode.removeChild(i)}if("clear_photo"===t.dataset.click){var s=$.post("https://"+server_uri+"/clear-photo?token="+my_token,{},function(){},"json");s.done(function(e){e.ok&&$(".avatar").prop("src",default_avatar)},"json")}if("i_choice_location"===t.dataset.click){document.location="#client__city";var l=getTempRequestLS();geocoder=new google.maps.Geocoder;var c=localStorage.getItem("_choice_coords");c=c.replace("(",""),c=c.replace(")",""),c=c.replace(" ",""),c=c.split(",");var d=new google.maps.LatLng(c[0],c[1]);geocoder.geocode({latLng:d},function(e,t){t===google.maps.GeocoderStatus.OK&&(localStorage.setItem("_address_"+l,getStreenFromGoogle(e)),$('input[name="from"]').val(localStorage.getItem("_address_from")),$('input[name="to"]').val(localStorage.getItem("_address_to")))})}t=t.parentNode}}),t.addEventListener("submit",function(e){for(var t=e.target;t!==this;){if("taxy-client-city"===t.dataset.submit){var o=document.querySelectorAll(".adress_from")[0].value,n=document.querySelectorAll(".adress_to")[0].value,a=document.querySelectorAll('[name="cost"]')[0].value,r=document.querySelectorAll('[name="description"]')[0].value;saveAddress(o,n);var i=new FormData;return i.append("fromCity",my_city),i.append("fromAddress",o),i.append("toCity0",my_city),i.append("toAddress0",n),i.append("isIntercity",0),i.append("price",a),i.append("comment",r),i.append("minibus",0),i.append("babyChair",0),void $.ajax({processData:!1,enctype:"multipart/form-data",dataType:"json",contentType:!1,url:"https://"+server_uri+"/order?token="+my_token,type:"POST",data:i,success:function(e){console.log(e.messages),e.ok&&(console.log("id="+e.id),document.location="#client__map")}})}if("form-auth"===t.dataset.submit){var s=$.post("https://"+server_uri+"/register?phone=7"+$('input[name="phone"]').val(),function(){},"json");s.done(function(e){e.ok&&(localStorage.setItem("_my_token",e.token),my_token=e.token,document.location="#pages__sms")},"json")}if("form-auth-sms"===t.dataset.submit){var s=$.post("https://"+server_uri+"/confirm?token="+my_token+"&smsCode="+$('input[name="sms"]').val(),function(){},"json");s.done(function(e){e.ok&&(localStorage.setItem("_is_auth","true"),document.location="/")},"json")}if("form-edit-profile"===t.dataset.submit){var l=$("input[name=ava_file]").prop("files")[0],i=new FormData;i.append("photo",l,l.name),i.append("name",$("input[name=name]").val()),i.append("birthday",dateToBase($("input[name=dob]").val())),i.append("city",$("select[name=city]").val()),i.append("sex",$("select[name=sex]").val()),$.ajax({processData:!1,enctype:"multipart/form-data",dataType:"json",contentType:!1,url:"https://"+server_uri+"/profile?token="+my_token,type:"POST",data:i,success:function(e){e.ok&&(document.location="/")}})}if("form-edit-auto"===t.dataset.submit){var s=$.post("https://"+server_uri+"/profile?token="+my_token,{color:$('input[name="color"]').val(),number:$('input[name="number"]').val(),model:$('input[name="model"]').val(),tonnage:$('input[name="tonnage"]').val(),brand:$('select[name="brand"] option:selected').text()},function(){},"json");s.done(function(e){e.ok},"json");var c=$.post("https://"+server_uri+"/auto?token="+my_token,{conditioner:$('input[name="conditioner"]:checked').val(),type:$('select[name="type"] option:selected').val()},function(){},"json");c.done(function(e){e.ok&&(document.location="/")},"json")}t=t.parentNode}}),t.addEventListener("keypress",function(e){for(var t=e.target;t!==this;){if("input_only_digits"===t.dataset.keypress){if(e.ctrlKey||e.altKey||e.metaKey)return;var o=getChar(e);return void(("0">o||o>"9")&&e.preventDefault())}if("input_only_date"===t.dataset.keypress){var n=t.value;if(console.log(n),n.length>9&&e.preventDefault(),e.ctrlKey||e.altKey||e.metaKey)return;var o=getChar(e);(0===n.length&&o>"3"||(3===n.length||2===n.length)&&o>"1"||(5===n.length||4===n.length)&&o>"2")&&e.preventDefault(),(2===n.length||5===n.length)&&(t.value+="."),("0">o||o>"9")&&e.preventDefault()}t=t.parentNode}}),t.addEventListener("keyup",function(e){for(var t=e.target;t!==this;){if("filter_intercity_to"===t.dataset.keyup){var o=t.parentNode.parentNode.parentNode.dataset.tabcontent,n=document.querySelectorAll('[data-tabcontent="'+o+'"]')[0];return void searchCityForIntercity(t.value,n)}t=t.parentNode}}),window.addEventListener("resize",function(){init()}),checkURL(),setInterval("checkURL()",250),init()});