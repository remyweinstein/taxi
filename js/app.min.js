function init(){if(""!==my_token){var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/profile?token="+my_token,!0),e.onload=function(){if(200===e.status){var t=JSON.parse(e.responseText);t.ok||"#pages__sms"===lasturl?(my_phone=t.profile.phone,my_name=t.profile.name,my_city=t.profile.city,my_avatar=t.profile.photo,document.querySelectorAll(".jq_my_name").length&&(document.querySelector(".jq_my_name").innerHTML=my_name,document.querySelector(".jq_my_phone").innerHTML=my_phone,my_avatar||(my_avatar=default_avatar),document.querySelector(".menu__desc_avatar").src=my_avatar)):(is_auth=!1,my_token="",localStorage.removeItem("_is_auth"),localStorage.removeItem("_my_token"))}},e.send()}if(document.querySelectorAll('[data-id="driver_city_orders"]').length){var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/orders?token="+my_token+"&isIntercity=0&fromCity="+my_city,!0),e.onload=function(){function t(e,t){var o=document.createElement(e);o.innerHTML=t,r.appendChild(o)}if(200===e.status){var o=JSON.parse(e.responseText);console.log("Ok?: "+o.ok+", orders="+o.orders),console.log("Messages: "+o.messages);for(var r=document.querySelector(".list-orders"),n=0;n<o.orders.length;n++)t("LI",'<div class="list-orders_personal"><img src="'+o.orders[n].agent.photo+'" alt="" /><br/>'+o.orders[n].agent.name+"<br/>"+datetimeForPeople(o.orders[n].created)+'</div><div class="list-orders_route"><div class="list-orders_route_from">'+o.orders[n].fromAddress+'</div><div class="list-orders_route_to">'+o.orders[n].toAddress0+'</div><div class="list-orders_route_info"><span>'+o.orders[n].price+' руб.</span> <i class="icon-direction-outline"></i>? км</div><div class="list-orders_route_additional">'+o.orders[n].comment+"</div></div>");o.orders.length<1&&t("DIV",'<div class="list-orders_norecords">Нет заказов</div>')}},e.send()}if(document.querySelectorAll('[data-id="client_my_orders"]').length){var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/orders?token="+my_token+"&isIntercity=0&my=1",!0),e.onload=function(){function t(e,t){var o=document.createElement(e);o.innerHTML=t,r.appendChild(o)}if(200===e.status){var o=JSON.parse(e.responseText);console.log("Ok?: "+o.ok+", orders="+o.orders),console.log("Messages: "+o.messages);for(var r=document.querySelector(".myorders"),n=0;n<o.orders.length;n++)t("LI",'<p class="myorders__time">'+datetimeForPeople(o.orders[n].created)+'</p><p class="myorders__from">'+o.orders[n].fromAddress+'</p><p class="myorders__to">'+o.orders[n].toAddress0+'</p><p class="myorders__summa">'+o.orders[n].price+'</p><p class="myorders__info">'+o.orders[n].comment+"</p>");o.orders.length<1&&t("DIV",'<div class="list-orders_norecords">Нет заказов</div>')}},e.send()}if(document.querySelectorAll(".jq_form-edit-auto").length){var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/profile?token="+my_token,!0),e.onload=function(){if(200===e.status){var t=JSON.parse(e.responseText);document.querySelector('input[name="color"]').value=t.profile.color,document.querySelector('input[name="number"]').value=t.profile.number,document.querySelector('input[name="model"]').value=t.profile.model,document.querySelector('input[name="tonnage"]').value=t.profile.tonnage;var o=$('select[name="brand"] option[value="'+t.profile.brand+'"]');o.attr("selected","true")}},e.send();var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/auto?token="+my_token,!0),e.onload=function(){if(200===e.status){var t=JSON.parse(e.responseText),o=$(t.auto.conditioner?'input[name="conditioner"][value="1"]':'input[name="conditioner"][value="0"]');o.attr("checked","checked");var r=$('select[name="type"] option[value="'+t.auto.type+'"]');r.attr("selected","true")}},e.send()}if(document.querySelectorAll(".jq_form-edit-profile").length){var e=new XMLHttpRequest;e.open("GET","https://"+server_uri+"/profile?token="+my_token,!0),e.onload=function(){if(200===e.status){var t=JSON.parse(e.responseText);document.querySelector('input[name="name"]').value=t.profile.name,document.querySelector('input[name="dob"]').value=dateFromBase(t.profile.birthday);var o=$(t.profile.sex?'select[name="sex"] option[value="1"]':'select[name="sex"] option[value="0"]');o.attr("selected","true");var r=$('select[name="city"] option[value="'+t.profile.city+'"]');r.attr("selected","true"),document.querySelector(".avatar").src=my_avatar}},e.send()}if(document.querySelector(".content").style.height=window.innerHeight-outerHeight(document.querySelector(".header"))+"px",tabs=$(".tabs ul li"),tabs.length){var t=tabs.length;tabs.css("width",100/t-1+"%"),$(".tabs__viewport").css("width",t*$(window).width()+"px"),$(".tabs_content").css("width",$(window).width()),new Hammer($(".tabs__wrapper")[0],{domEvents:!0})}document.querySelectorAll(".form-order-city").length&&(document.querySelector('input[name="from"]').value=localStorage.getItem("_address_from"),document.querySelector('input[name="to"]').value=localStorage.getItem("_address_to")),document.querySelectorAll("#map_canvas_choice").length&&initialize_choice(),document.querySelectorAll("#map_canvas").length&&initialize(),$(".tabs_content").on("swipeleft",function(){swipeTabs(1)}),$(".tabs_content").on("swiperight",function(){swipeTabs(-1)})}function geoFindMe(){function e(e){var t=e.coords.latitude,o=e.coords.longitude;my_position.x=t,my_position.y=o,geocoder=new google.maps.Geocoder;var r=new google.maps.LatLng(t,o);geocoder.geocode({latLng:r},function(e,t){if(t===google.maps.GeocoderStatus.OK){var o,r=e[0].address_components;for(o in r)"locality"===r[o].types[0]&&""!==my_city&&(my_city=r[o].long_name),"country"===r[o].types[0]&&(my_coutry=r[o].long_name)}})}function t(){alert("На вашем устройстве не разрешен доступ к местоположению.")}return navigator.geolocation?void navigator.geolocation.getCurrentPosition(e,t):void alert("К сожалению, геолокация не поддерживается в вашем браузере")}function swipeMenu(e){var t=document.querySelector(".menu"),o=e>0?"opened":"closed";t.classList.remove("menu--closed"),t.classList.remove("menu--opened"),t.classList.add("menu--"+o)}function swipeTabs(e){var t=$(".tab--active").data("tab");t+e<tabs.length+1&&t+e>0&&changeTab(t+e)}function changeTab(e){step=$(window).width(),$(".tabs_content").css("left",step-step*e+"px"),tabs.removeClass("tab--active"),$('*[data-tab="'+e+'"]').addClass("tab--active")}function checkURL(e){sublasturl=lasturl,e||(e=window.location.hash?window.location.hash:"#client__city"),e!==lasturl&&(lasturl=e,loadPage(e))}function loadPage(e){e=e.replace("#","");var t=e.split("__");document.querySelector(".loading").style.visibility="visible";var t=new FormData;t.append("section",t[0]),t.append("page",t[1]);var o=new XMLHttpRequest;o.open("POST","routes.php",!0),o.onload=function(){if(200===o.status){var e=JSON.parse(o.responseText);console.log(e),console.log(e.content),document.querySelector(".header__title").innerHTML=e.title,document.querySelector(".content").innerHTML=e.content,(t[0]!==lastsection||""===lastsection)&&(document.querySelector(".menu__response").innerHTML=e[0].menu),lastsection=t[0],document.querySelector(".loading").style.visibility="hidden",init()}},o.send(t)}function initialize(){var e=new google.maps.LatLng(48.49,135.07),t=document.getElementById("map_canvas"),o={center:e,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(t,o),directionsService=new google.maps.DirectionsService;var r=loadAddress();requestDirections(r[0],r[1],{strokeColor:"#ff0000"})}function initialize_choice(){if(o=18,void 0===my_position.x||void 0===my_position.y)var e=48.4,t=135.07,o=12;else var e=my_position.x,t=my_position.y;var r=new google.maps.LatLng(e,t),n=document.getElementById("map_canvas_choice"),a={center:r,zoom:o,mapTypeId:google.maps.MapTypeId.ROADMAP};map_choice=new google.maps.Map(n,a),map_choice.getDiv().insertAdjacentHTML("beforeend",'<div class="centerMarker"></div>');var i=document.querySelectorAll(".centerMarker")[0];google.maps.event.addListener(map_choice,"drag",function(){var e=point2LatLng(i.offsetLeft,i.offsetTop,map_choice);localStorage.setItem("_choice_coords",e)})}function renderDirections(e,t){var o=new google.maps.DirectionsRenderer;o.setMap(map),t&&o.setOptions({polylineOptions:t}),o.setDirections(e)}function requestDirections(e,t,o){directionsService.route({origin:e,destination:t,travelMode:google.maps.DirectionsTravelMode.DRIVING},function(e){renderDirections(e,o)})}function getChar(e){return null===e.which?e.keyCode<32?null:String.fromCharCode(e.keyCode):0!==e.which?e.which<32?null:String.fromCharCode(e.which):null}function setTempRequestLS(e){return localStorage.setItem("_temp_request",e),!0}function getTempRequestLS(){var e=localStorage.getItem("_temp_request");return localStorage.removeItem("_temp_request"),e}function saveAddress(e,t){return localStorage.setItem("_address_from",e),localStorage.setItem("_address_to",t),!0}function loadAddress(){var e=my_city+","+localStorage.getItem("_address_from"),t=my_city+","+localStorage.getItem("_address_to");return[e,t]}function point2LatLng(e,t,o){var r=o.getProjection().fromLatLngToPoint(o.getBounds().getNorthEast()),n=o.getProjection().fromLatLngToPoint(o.getBounds().getSouthWest()),a=Math.pow(2,o.getZoom()),i=new google.maps.Point(e/a+n.x,t/a+r.y);return o.getProjection().fromPointToLatLng(i)}function getStreenFromGoogle(e){var t,o,r=e[0].address_components;for(t in r)"street_number"===r[t].types[0]&&(o=r[t].long_name),"route"===r[t].types[0]&&(o=r[t].long_name+","+o);return o}function searchCityForIntercity(e,t){for(var o,r=t.children[1].children,n=0;n<r.length;n++)o=r[n].children[1].children[3].innerHTML,r[n].style.display=o===e||""===e?"flex":"none"}function dateFromBase(e){return"0000-00-00"===e?e="":(e=e.split("-"),e=e[2]+"."+e[1]+"."+e[0]),e}function dateToBase(e){return e=e.split("."),e=e[2]+"-"+e[1]+"-"+e[0]}function outerHeight(e){var t=e.offsetHeight,o=getComputedStyle(e);return t+=parseInt(o.marginTop)+parseInt(o.marginBottom)}function datetimeForPeople(e,t){void 0===t&&(t="TIME_AND_TODAY"),e=e.split(" ");var o=new Date,r=new Date(o.getFullYear(),o.getMonth(),o.getDate()).valueOf(),n=e[0].valueOf();if(r-864e5>n){var a=e[0].split("-");today_text=a[2]+"."+a[1]+"."+a[0]}else today_text=r>n?"Вчера":"Сегодня";var a=e[1].split(":");return time_text=a[0]+":"+a[1],"ONLY_TIME"===t&&(e=time_text),"ONLY_TIME_IF_TODAY"===t&&(e="Сегодня"===today_text?time_text:today_text+", "+time_text),"TIME_AND_TODAY"===t&&(e=today_text+", "+time_text),e}var tabs,lasturl="",sublasturl="",lastsection="",map,map_choice,marker,geocoder,google,placeSearch,autocomplete,directionsService,my_position=["x","y"],server_uri="192.168.20.90",my_city,my_country,my_token,is_auth=!1,my_name,my_phone,my_avatar,default_avatar="images/no_avatar.png";document.addEventListener("DOMContentLoaded",function(){"true"===localStorage.getItem("_is_auth")&&(is_auth=!0),my_token=localStorage.getItem("_my_token"),geoFindMe();var e=document.querySelector(".menu");new Hammer(e,{domEvents:!0}),e.addEventListener("swipeleft",function(){swipeMenu(-1)}),e.addEventListener("click",function(e){for(var t=e.target;t!==this;){if("A"===t.tagName){for(var o=t.parentNode,r=o.parentNode.querySelectorAll("li"),n=0;n<r.length;n++)r[n].className=r[n].className.replace(/^menu__list--active$/,"");o.className+="menu__list--active",swipeMenu(-1)}if("edit_profile"===t.dataset.click)return swipeMenu(-1),void(document.location="#pages__edit_profile");t=t.parentNode}}),document.querySelector(".header__burger").addEventListener("click",function(){swipeMenu(1)});var t=document.querySelector(".content");t.addEventListener("click",function(e){for(var t=e.target;t!==this;){if(t.dataset.tab>0)return void changeTab(t.dataset.tab);if("choice_location"===t.dataset.click)return document.location="#client__choice_location_map",void setTempRequestLS(t.parentNode.querySelectorAll("input")[0].getAttribute("name"));if("field_add"===t.dataset.click){var o=document.querySelectorAll(".icon-record").length;if(3>o){var r=document.querySelector(".order-city-to"),n=document.createElement("div");n.className+="form-order-city__field order-city-from",n.innerHTML='<i class="icon-record form-order-city__label"></i><span class="form-order-city__wrap"><input type="text" name="from_plus[]" value="" placeholder="Заезд"/></span><span data-click="field_delete" class="form-order-city__field_delete"><i class="icon-trash"></i></span>';var a=r.parentNode;a.insertBefore(n,r)}return}if("field_delete"===t.dataset.click){var i=t.parentNode;return void i.parentNode.removeChild(i)}if("clear_photo"===t.dataset.click){var s=$.post("https://"+server_uri+"/clear-photo?token="+my_token,{},function(){},"json");s.done(function(e){e.ok&&$(".avatar").prop("src",default_avatar)},"json")}if("i_choice_location"===t.dataset.click){document.location="#client__city";var c=getTempRequestLS();geocoder=new google.maps.Geocoder;var l=localStorage.getItem("_choice_coords");l=l.replace("(",""),l=l.replace(")",""),l=l.replace(" ",""),l=l.split(",");var d=new google.maps.LatLng(l[0],l[1]);geocoder.geocode({latLng:d},function(e,t){t===google.maps.GeocoderStatus.OK&&(localStorage.setItem("_address_"+c,getStreenFromGoogle(e)),document.querySelector('input[name="from"]').value=localStorage.getItem("_address_from"),document.querySelector('input[name="to"]').value=localStorage.getItem("_address_to"))})}t=t.parentNode}}),t.addEventListener("submit",function(e){for(var t=e.target;t!==this;){if("taxy-client-city"===t.dataset.submit){var o=document.querySelector(".adress_from").value,r=document.querySelector(".adress_to").value,n=document.querySelector('[name="cost"]').value,a=document.querySelector('[name="description"]').value;saveAddress(o,r);var i=new FormData;i.append("fromCity",my_city),i.append("fromAddress",o),i.append("toCity0",my_city),i.append("toAddress0",r),i.append("isIntercity",0),i.append("price",n),i.append("comment",a),i.append("minibus",0),i.append("babyChair",0);var s=new XMLHttpRequest;return s.open("POST","https://"+server_uri+"/order?token="+my_token,!0),s.onload=function(){if(200===s.status){var e=JSON.parse(s.responseText);e.ok&&(console.log("id="+e.id),document.location="#client__map")}},void s.send(i)}if("form-auth"===t.dataset.submit){var s=new XMLHttpRequest;s.open("POST","https://"+server_uri+"/register?phone=7"+document.querySelector('input[name="phone"]').value,!0),s.onload=function(){if(200===s.status){var e=JSON.parse(s.responseText);e.ok&&(localStorage.setItem("_my_token",e.token),my_token=e.token,document.location="#pages__sms")}},s.send()}if("form-auth-sms"===t.dataset.submit){var s=new XMLHttpRequest;s.open("POST","https://"+server_uri+"/confirm?token="+my_token+"&smsCode="+document.querySelector('input[name="sms"]').value,!0),s.onload=function(){if(200===s.status){var e=JSON.parse(s.responseText);e.ok&&(localStorage.setItem("_is_auth","true"),document.location="/")}},s.send()}if("form-edit-profile"===t.dataset.submit){var c=document.querySelector("input[name=ava_file]").files[0],i=new FormData;i.append("photo",c,c.name),i.append("name",document.querySelector("input[name=name]").value),i.append("birthday",dateToBase(document.querySelector("input[name=dob]").value)),i.append("city",document.querySelector("select[name=city]").value),i.append("sex",document.querySelector("select[name=sex]").value);var s=new XMLHttpRequest;s.open("POST","https://"+server_uri+"/profile?token="+my_token,!0),s.onload=function(){if(200===s.status){var e=JSON.parse(s.responseText);e.ok&&(document.location="/")}},s.send(i)}if("form-edit-auto"===t.dataset.submit){var l=document.querySelector('select[name="brand"]'),d=document.querySelector('select[name="type"]'),u=$.post("https://"+server_uri+"/profile?token="+my_token,{color:document.querySelector('input[name="color"]').value,number:document.querySelector('input[name="number"]').value,model:document.querySelector('input[name="model"]').value,tonnage:document.querySelector('input[name="tonnage"]').value,brand:l.options[l.selectedIndex].text},function(){},"json");u.done(function(e){e.ok},"json");var m=$.post("https://"+server_uri+"/auto?token="+my_token,{conditioner:document.querySelector('input[name="conditioner"]:checked').value,type:d.options[d.selectedIndex].text},function(){},"json");m.done(function(e){e.ok&&(document.location="/")},"json")}t=t.parentNode}}),t.addEventListener("keypress",function(e){for(var t=e.target;t!==this;){if("input_only_digits"===t.dataset.keypress){if(e.ctrlKey||e.altKey||e.metaKey)return;var o=getChar(e);return void(("0">o||o>"9")&&e.preventDefault())}if("input_only_date"===t.dataset.keypress){var r=t.value;if(console.log(r),r.length>9&&e.preventDefault(),e.ctrlKey||e.altKey||e.metaKey)return;var o=getChar(e);(0===r.length&&o>"3"||(3===r.length||2===r.length)&&o>"1"||(5===r.length||4===r.length)&&o>"2")&&e.preventDefault(),(2===r.length||5===r.length)&&(t.value+="."),("0">o||o>"9")&&e.preventDefault()}t=t.parentNode}}),t.addEventListener("keyup",function(e){for(var t=e.target;t!==this;){if("filter_intercity_to"===t.dataset.keyup){var o=t.parentNode.parentNode.parentNode.dataset.tabcontent,r=document.querySelectorAll('[data-tabcontent="'+o+'"]')[0];return void searchCityForIntercity(t.value,r)}t=t.parentNode}}),window.addEventListener("resize",function(){init()}),checkURL(),setInterval("checkURL()",250),init()});