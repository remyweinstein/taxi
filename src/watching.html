<!--offer=743&hash=ece19dd8e4e1282efdfdd79d077d7e78-->
<!DOCTYPE html>
<html>
    <!--debug="true">-->
    <head>
        <title>Tech Agent</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <link href="assets/css/main.css?v=0.25" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSC865M_6PnMKScURizBAegCpZXBKzMRs"></script>
        <style>
            #mapCanvas {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="mapCanvas"></div>
        
        <script>
        var params = window.location.search,
            socket = null,
            token = null,
            firsTime = true;
        
        params = (params.substr(1)).split('&');
        
        var offer = params[0].split('=')[1],
            hash  = params[1].split('=')[1];
        
        function start() {
          socket = new WebSocket("wss://192.168.20.90:4443");

          socket.onopen = function () {
            startGetOffer();
          };

          socket.onmessage = function(event) {
            onMessage(event.data);
          };
        }
        
        function startGetOffer() {
          var req = {};

          req.method = "get-orders";
          req.id = "get-orders";
          req.params = {};
          req.params.offerId = offer;
          req.params.hash = hash;
          //req.params.token = token;
          socket.send(JSON.stringify(req));
        }
        
        function onMessage(data) {
          var response = JSON.parse(data);

          viewLog(response);

          if (!response.error) {
              if (response.id === "get-orders") {
                  viewLog(response.result);
                  render(response.result);
              }
          }
        }
        
        function viewLog(text) {
            console.log(text);
        }
        
        function render(response) {
            if (firsTime) {
                firsTime = false;
                startRender(response);
            } else {
                changePositions(response);
            }   
        }
        
        function startRender(response) {
            if (response.orders.length === 0) {
              stop();
              return;
            }

            var ords = response.orders[0];

            if (!ords) {
                stop();
                return;
            }

            fromCoords          = ords.fromLocation.split(",");
            toCoords            = ords.toLocation.split(",");
            drawRoute(fromCoords, toCoords);
        }
        
        function changePositions(response) {
            
        }
        
        function drawRoute(from, to) {
            var directionsService = new google.maps.DirectionsService(),
                from = from.split(","),
                to   = to.split(","),
                request = {
                  origin: new google.maps.LatLng(from[0], from[1]),
                  destination: new google.maps.LatLng(to[0], to[1]),
                  //waypoints: waypoints,
                  provideRouteAlternatives: false,
                  travelMode: google.maps.DirectionsTravelMode.DRIVING
                };
                
            directionsService.route(request, function(response, status) {
              if (status === google.maps.DirectionsStatus.OK) {
                new google.maps.DirectionsRenderer({
                  map: Maps.map,
                  directions: response,
                  routeIndex: 0
                });
              }
            });
        }
        
        function stop() {
            alert('Заказ не найден');
            var req = {};

            req.method = "stop-get-orders";
            //req.params.token = token;
            socket.send(JSON.stringify(req));
        }
        
        start();
        
	var myOptions = {
		zoom: 6,
		center: new google.maps.LatLng(48.472564, 135.064280),
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
        
	var map = new google.maps.Map(document.getElementById("mapCanvas"), myOptions); 

        </script>
    </body>
</html>